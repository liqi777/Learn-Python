

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>“应用层参数存取模块”和“系统状态监控模块”在各模块中的布置 &mdash; Learn Python hello documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="#" class="icon icon-home"> Learn Python
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">“应用层参数存取模块”和“系统状态监控模块”在各模块中的布置</a><ul>
<li><a class="reference internal" href="#">1. 说明</a></li>
<li><a class="reference internal" href="#">2.“应用层参数存取模块”及其在各模块中的布置</a><ul>
<li><a class="reference internal" href="#">2.1 参数划分</a></li>
<li><a class="reference internal" href="#">2.2应用层参数存取服务模块</a></li>
<li><a class="reference internal" href="#">2.3各模块中的布置</a></li>
</ul>
</li>
<li><a class="reference internal" href="#">3.“系统状态监控模块”及其在各模块中的布置</a><ul>
<li><a class="reference internal" href="#">3.1系统状态</a></li>
<li><a class="reference internal" href="#">3.2系统状态监控模块</a></li>
<li><a class="reference internal" href="#">3.3各模块中的布置</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">Learn Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="#">Docs</a> &raquo;</li>
        
      <li>“应用层参数存取模块”和“系统状态监控模块”在各模块中的布置</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/index.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="">
<span id="id1"></span><h1>“应用层参数存取模块”和“系统状态监控模块”在各模块中的布置<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h1>
<div class="section" id="">
<span id="id2"></span><h2>1. 说明<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h2>
<p>根据之前的方案设计，“应用层参数存取模块”仅提供参数存取接口以及参数总体划分规则，真正的参数存取过程由各模块自己执行；同样，“系统状态监控模块”需要向各个模块获取获取状态相关的信息，因此各模块需要实现相关的接口，具体方案详见下文；</p>
</div>
<div class="section" id="">
<span id="id3"></span><h2>2.“应用层参数存取模块”及其在各模块中的布置<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h2>
<div class="section" id="">
<span id="id4"></span><h3>2.1 参数划分<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p><img alt="" src="_images/para.png" /></p>
<p>如上图所示，参数根据模块号和num号标识，module定义具体实现请看下文，num编号从0-0xFFFFFFFF，由各模块自行决定，参数长度未限制（esp32环境下底层限制为最大为1984Bytes）;</p>
</div>
<div class="section" id="">
<span id="id5"></span><h3>2.2应用层参数存取服务模块<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">enum</span>
<span class="p">{</span>
    <span class="n">APS_PARA_MODULE_GENERAL</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// MODULE 0  FOR LOG</span>
    <span class="n">APS_PARA_MODULE_DAEMON</span><span class="p">,</span>
    <span class="n">APS_PARA_MODULE_LAMP</span><span class="p">,</span>
    <span class="n">APS_PARA_MODULE_APS_LAMP</span><span class="p">,</span>
    <span class="n">APS_PARA_MODULE_APS_METER</span><span class="p">,</span>
    <span class="n">APS_PARA_MODULE_APS_RTC</span><span class="p">,</span>
    <span class="n">APS_PARA_MODULE_ASP_PTCHUAWEI</span><span class="p">,</span>
    <span class="n">APS_PARA_MODULE_APS_PTCOPPLE</span><span class="p">,</span>
<span class="p">}</span><span class="n">t_aps_para_module</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">AppParaInit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">AppParaRead</span><span class="p">(</span><span class="kt">int</span> <span class="n">module</span><span class="p">,</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">lenMax</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">AppParaWrite</span><span class="p">(</span><span class="kt">int</span> <span class="n">module</span><span class="p">,</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">AppParaReadU32</span><span class="p">(</span><span class="kt">int</span> <span class="n">module</span><span class="p">,</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span> <span class="n">data</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">AppParaWriteU32</span><span class="p">(</span><span class="kt">int</span> <span class="n">module</span><span class="p">,</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">);</span>

</pre></div>
</div>
<p>由上文可知，一个模块需要使用参数存取服务，必须从t_aps_para_module中分配一个module号；</p>
</div>
<div class="section" id="">
<span id="id6"></span><h3>2.3各模块中的布置<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>一个包含参数存取功能的模块，需要和外界交互，实现参数修改，读出功能，因此需要自身实现以下接口（具体代码可以参照系统状态监控模块）：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">paraSet</span><span class="p">(</span><span class="n">para</span><span class="p">,</span><span class="n">len</span><span class="p">);</span> <span class="c1">// 根据不同模块不同功能，可能对每个num单独提供接口</span>
<span class="kt">int</span> <span class="nf">paraGet</span><span class="p">(</span><span class="n">para</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
</pre></div>
</div>
<p>且其内部实现模式一般为：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">U8</span> <span class="n">para</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>  <span class="c1">// 定义参数本地存储结构</span>
<span class="k">const</span> <span class="n">U8</span> <span class="n">paraDefault</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span> <span class="c1">// 默认参数</span>

<span class="cm">/*从flash加载参数*/</span>
<span class="kt">int</span> <span class="nf">loadPara</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">AppParaRead</span><span class="p">(</span><span class="n">module</span><span class="p">,</span><span class="n">num</span><span class="p">,</span><span class="n">para</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*加载默认参数*/</span>
<span class="kt">void</span> <span class="nf">loadParaDefault</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">para</span><span class="p">,</span><span class="n">paraDefault</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*参数设置*/</span>
<span class="kt">int</span> <span class="nf">paraSet</span><span class="p">(</span><span class="n">U8</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">AppParaWrite</span><span class="p">(</span><span class="n">module</span><span class="p">,</span><span class="n">num</span><span class="p">,</span><span class="n">para</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// 写入Flash</span>
    <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">para</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span> <span class="c1">// 写入Flash成功后，拷贝到ram中</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*参数获取*/</span>
<span class="kt">int</span> <span class="nf">paraGet</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span><span class="kt">int</span> <span class="n">lenMax</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">lenMax</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">para</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span> <span class="c1">// 直接返回ram中的数据，不直接执行flash操作,节省时间</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">moduleInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">loadPara</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span> <span class="c1">// 加载flash中的参数</span>
        <span class="n">loadParaDefault</span><span class="p">();</span> <span class="c1">// 加载失败则加载默认参数</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="">
<span id="id7"></span><h2>3.“系统状态监控模块”及其在各模块中的布置<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h2>
<div class="section" id="">
<span id="id8"></span><h3>3.1系统状态<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p><img alt="" src="_images/status.png" /></p>
<p>如图所示，当输入模块名和状态码后，模块将提供详细的信息，得到该信息后是否上报、报警、生成日志可以配置，模块名由本模块分配，code内容由各模块自行定义；</p>
</div>
<div class="section" id="">
<span id="id9"></span><h3>3.2系统状态监控模块<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>（1）配置表</p>
<p>模块提供一个配置表，即每个模块的状态码产生的状态信息是否生成上报、报警、日志可配置；（这部分内容其他模块只需要了解即可，不直接交互）</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">enable</span><span class="p">;</span>
    <span class="n">t_mc_module</span>   <span class="n">module</span><span class="p">;</span> <span class="c1">// </span>
    <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">action</span><span class="p">;</span> <span class="c1">// action | t_mc_action</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">code</span><span class="p">;</span>
<span class="p">}</span><span class="n">t_module_status_code</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span>
<span class="p">{</span>
    <span class="n">MC_ACTION_LOG</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span>
    <span class="n">MC_ACTION_REPORT</span><span class="o">=</span><span class="mh">0x02</span><span class="p">,</span>
    <span class="n">MC_ACTION_ALARM</span><span class="o">=</span><span class="mh">0x04</span><span class="p">,</span>
<span class="p">}</span><span class="n">t_mc_action</span><span class="p">;</span>

<span class="k">static</span> <span class="n">t_module_status_code</span> <span class="n">code</span><span class="p">[</span><span class="n">MODULE_STATUS_ITEM_MAX</span><span class="p">];</span> <span class="c1">// 配置表</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="nf">ApsDaemonActionItemParaSet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span><span class="n">t_module_status_code</span><span class="o">*</span> <span class="n">code</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">ApsDaemonActionItemParaGet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span><span class="n">t_module_status_code</span><span class="o">*</span> <span class="n">code</span><span class="p">);</span>
</pre></div>
</div>
<p>（2）注册表</p>
<p>本模块需要其他模块提供获取状态码和状态码生成日志的接口：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MODULE_INFO_LIST {\</span>
<span class="cp">    {.module=MC_MODULE_GENERAL,.name=&quot;&quot;,.fun=(void*)0,.cfun=(void*)0},\</span>
<span class="cp">    {.module=MC_MODULE_NB,     .name=&quot;&quot;,.fun=(void*)0,.cfun=(void*)0},\</span>
<span class="cp">    {.module=MC_MODULE_WIFI,   .name=&quot;&quot;,.fun=(void*)0,.cfun=(void*)0},\</span>
<span class="cp">    {.module=MC_MODULE_PM,     .name=&quot;&quot;,.fun=(void*)0,.cfun=(void*)0},\</span>
<span class="cp">    {.module=MC_MODULE_LAMP,   .name=&quot;&quot;,.fun=(void*)0,.cfun=(void*)0},\</span>
<span class="cp">    {.module=MC_MODULE_PARA,   .name=&quot;&quot;,.fun=(void*)0,.cfun=(void*)0},\</span>
<span class="cp">}; </span><span class="c1">// 注册表</span>

<span class="k">typedef</span> <span class="k">enum</span>
<span class="p">{</span>
    <span class="n">MC_MODULE_GENERAL</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">MC_MODULE_NB</span><span class="p">,</span>
    <span class="n">MC_MODULE_WIFI</span><span class="p">,</span>
    <span class="n">MC_MODULE_PM</span><span class="p">,</span> 
    <span class="n">MC_MODULE_LAMP</span><span class="p">,</span>
    <span class="n">MC_MODULE_PARA</span><span class="p">,</span>
<span class="cm">/********************************/</span>
    <span class="n">MC_MODULE_MAX</span><span class="p">,</span>
<span class="p">}</span><span class="n">t_mc_module</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span> <span class="c1">// 0:alarm disappear,1:alarm appear</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">level</span><span class="p">;</span>  <span class="c1">// </span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">time</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span> <span class="c1">// Y-M-D H-M-S(Year=Y+2000)</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">desp</span><span class="p">[</span><span class="n">MODULE_STATUS_DESP_LEN_MAX</span><span class="p">];</span>
<span class="p">}</span><span class="n">t_module_status_result</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pfGetModuleStatus</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span><span class="n">t_module_status_result</span><span class="o">*</span><span class="p">);</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pfGetCodeLog</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="n">code</span><span class="p">,</span><span class="n">t_module_status_result</span><span class="o">*</span><span class="p">,</span><span class="kt">char</span><span class="o">*</span> <span class="n">log</span><span class="p">,</span><span class="kt">int</span> <span class="n">lenMax</span><span class="p">);</span>

<span class="k">static</span> <span class="n">t_mc_module_info</span> <span class="n">moduleInfo</span><span class="p">[</span><span class="n">MC_MODULE_MAX</span><span class="p">]</span><span class="o">=</span>\
<span class="n">MODULE_INFO_LIST</span><span class="p">;</span>
</pre></div>
</div>
<p>各子模块将接口实现后，注册到以上注册表即可；</p>
</div>
<div class="section" id="">
<span id="id10"></span><h3>3.3各模块中的布置<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>（1）各模块在t_mc_module中注册一个模块名</p>
<p>（2）各模块自定义状态码code内容，并将code对应内容获取接口（参照t_module_status_result）注册在本模块</p>
<p>（3）各模块将code生成显示log的接口注册在本模块，将生成以下spec部分内容</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// [Date time][Module,level]code_spec</span>
<span class="c1">// [2018-4-8 16:29:38][module,warn/error...]spec</span>
</pre></div>
</div>
<p>（4）t_module_status_result中desp[]内容需要有一定的固定格式，详细格式参照华为协议处理模块中各上报消息接口；</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, hello.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'hello',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>